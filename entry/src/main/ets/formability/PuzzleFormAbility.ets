import { FormExtensionAbility, formBindingData, formProvider } from '@kit.FormKit';
import { Want } from '@kit.AbilityKit';
import { preferences } from '@kit.ArkData';
import { GameStorage, SavedGameState } from '../utils/GameStorage';
import { hilog } from '@kit.PerformanceAnalysisKit';

// æ—¥å¿—å¸¸é‡
const DOMAIN = 0xFE00;
const TAG = 'FormAbility';

/**
 * å¡ç‰‡æ•°æ®æ¥å£
 */
interface FormDataContent {
  title: string;
  gameMode: string;
  gridSize: string;
  moveCount: number;
  timeElapsed: string;
  hasActiveGame: boolean;
}

/**
 * æ‹¼å›¾æ¸¸æˆä¸‡èƒ½å¡ç‰‡æ‰©å±•èƒ½åŠ›
 */
export default class PuzzleFormAbility extends FormExtensionAbility {
  /**
   * åˆ›å»ºå¡ç‰‡æ—¶è°ƒç”¨
   */
  onAddForm(want: Want): formBindingData.FormBindingData {
    hilog.info(DOMAIN, TAG, '========== onAddForm è°ƒç”¨ ==========');
    hilog.info(DOMAIN, TAG, 'want.parameters: %{public}s', JSON.stringify(want.parameters));
    
    // å°è¯•å¤šç§æ–¹å¼è·å–å¡ç‰‡ID
    const formId: string = (want.parameters?.['ohos.extra.param.key.form_identity'] as string) ||
                           (want.parameters?.['formId'] as string) ||
                           (want.parameters?.['id'] as string) || '';
    
    hilog.info(DOMAIN, TAG, 'è·å–åˆ°çš„å¡ç‰‡ID: %{public}s', formId);
    
    if (formId) {
      // ğŸ”¥ ç«‹å³å¼€å§‹ä¿å­˜ï¼Œä¸ç­‰å¾…å®Œæˆï¼ˆç³»ç»Ÿä¿è¯åå°ä»»åŠ¡ä¼šæ‰§è¡Œï¼‰
      this.saveFormId(formId).then(() => {
        hilog.info(DOMAIN, TAG, 'âœ… å¡ç‰‡IDä¿å­˜å®Œæˆ');
      }).catch((error: Error) => {
        hilog.error(DOMAIN, TAG, 'âŒ å¡ç‰‡IDä¿å­˜å¤±è´¥: %{public}s', error.message);
      });
    } else {
      hilog.warn(DOMAIN, TAG, 'âš ï¸ æ— æ³•è·å–å¡ç‰‡ID');
    }
    
    // å‡†å¤‡å¡ç‰‡æ•°æ®
    const formData: FormDataContent = this.createDefaultFormData();

    // å¼‚æ­¥åŠ è½½æ¸¸æˆçŠ¶æ€
    this.loadGameStateAsync(formId);

    // è¿”å›FormBindingData
    return formBindingData.createFormBindingData(formData);
  }

  /**
   * ä¿å­˜å¡ç‰‡IDåˆ°æŒä¹…åŒ–å­˜å‚¨
   */
  private async saveFormId(formId: string): Promise<void> {
    try {
      // ğŸ”¥ å…³é”®ï¼šä½¿ç”¨åº”ç”¨çº§åˆ«çš„ contextï¼Œç¡®ä¿ä¸ EntryAbility å…±äº«åŒä¸€å­˜å‚¨
      const appContext = this.context.getApplicationContext();
      const dataPreferences: preferences.Preferences = await preferences.getPreferences(appContext, 'formIds');
      
      // è¯»å–ç°æœ‰çš„å¡ç‰‡IDåˆ—è¡¨
      const formIdsStr: string = await dataPreferences.get('ids', '[]') as string;
      const formIds: Array<string> = JSON.parse(formIdsStr);
      
      hilog.info(DOMAIN, TAG, 'ğŸ“– è¯»å–åˆ°ç°æœ‰å¡ç‰‡ID: %{public}s', JSON.stringify(formIds));
      
      // æ·»åŠ æ–°ID
      if (!formIds.includes(formId)) {
        formIds.push(formId);
        await dataPreferences.put('ids', JSON.stringify(formIds));
        await dataPreferences.flush();
        hilog.info(DOMAIN, TAG, 'âœ… å¡ç‰‡IDå·²ä¿å­˜: %{public}s æ€»æ•°: %{public}d', formId, formIds.length);
        hilog.info(DOMAIN, TAG, 'ğŸ“‹ å½“å‰æ‰€æœ‰å¡ç‰‡ID: %{public}s', JSON.stringify(formIds));
      } else {
        hilog.info(DOMAIN, TAG, 'â„¹ï¸ å¡ç‰‡IDå·²å­˜åœ¨ï¼Œè·³è¿‡ä¿å­˜: %{public}s', formId);
      }
    } catch (error) {
      hilog.error(DOMAIN, TAG, 'âŒ ä¿å­˜å¡ç‰‡IDå¤±è´¥: %{public}s', JSON.stringify(error));
    }
  }

  /**
   * åˆ›å»ºé»˜è®¤å¡ç‰‡æ•°æ®
   */
  private createDefaultFormData(): FormDataContent {
    return {
      title: 'æ‹¼å›¾æ¸¸æˆ',
      gameMode: 'äº¤æ¢',
      gridSize: '3Ã—3',
      moveCount: 0,
      timeElapsed: '00:00',
      hasActiveGame: false
    };
  }

  /**
   * ä»æ¸¸æˆçŠ¶æ€åˆ›å»ºå¡ç‰‡æ•°æ®
   */
  private createFormDataFromGameState(gameState: SavedGameState): FormDataContent {
    return {
      title: 'æ‹¼å›¾æ¸¸æˆ',
      gameMode: gameState.gameMode === 'swap' ? 'äº¤æ¢' : 'æ»‘åŠ¨',
      gridSize: `${gameState.gridSize}Ã—${gameState.gridSize}`,
      moveCount: gameState.moveCount,
      timeElapsed: this.formatTime(gameState.timeElapsed),
      hasActiveGame: true
    };
  }

  /**
   * å¼‚æ­¥åŠ è½½æ¸¸æˆçŠ¶æ€å¹¶æ›´æ–°å¡ç‰‡
   */
  private async loadGameStateAsync(formId: string): Promise<void> {
    try {
      const gameState = await GameStorage.loadGameState();
      
      let formData: FormDataContent;
      
        if (gameState && gameState.isPlaying) {
          formData = this.createFormDataFromGameState(gameState);
          hilog.info(DOMAIN, TAG, 'æ£€æµ‹åˆ°è¿›è¡Œä¸­çš„æ¸¸æˆï¼Œæ›´æ–°å¡ç‰‡æ˜¾ç¤ºç»§ç»­æ¸¸æˆ');
        } else {
          formData = this.createDefaultFormData();
          hilog.info(DOMAIN, TAG, 'æ— è¿›è¡Œä¸­çš„æ¸¸æˆï¼Œæ˜¾ç¤ºå¼€å§‹æ–°æ¸¸æˆ');
        }
  
        // ä½¿ç”¨ formProvider.updateForm æ›´æ–°å¡ç‰‡
        await formProvider.updateForm(formId, formBindingData.createFormBindingData(formData));
        hilog.info(DOMAIN, TAG, 'å¡ç‰‡æ›´æ–°æˆåŠŸ, formId: %{public}s', formId);
      } catch (error) {
        hilog.error(DOMAIN, TAG, 'æ›´æ–°å¡ç‰‡å¤±è´¥: %{public}s', JSON.stringify(error));
      }
  }

  /**
   * ğŸ”¥ åŠ è½½æ¸¸æˆçŠ¶æ€å¹¶æ¸…ç†è¿‡æœŸæ•°æ®
   * æ–¹æ¡ˆäºŒï¼šæ™ºèƒ½æ£€æµ‹è¿‡æœŸæ•°æ®ï¼ˆè¶…è¿‡24å°æ—¶ï¼‰
   */
  private async loadGameStateWithCleanupCheck(formId: string): Promise<void> {
    try {
      const gameState = await GameStorage.loadGameState();
      
      let formData: FormDataContent;
      
      if (gameState && gameState.isPlaying) {
        // ğŸ”¥ æ£€æµ‹æ¸¸æˆæ˜¯å¦è¿‡æœŸï¼ˆè¶…è¿‡8åˆ†é’Ÿæœªæ›´æ–°ï¼‰
        // åŸå› ï¼šæ¸…é™¤åå°æ—¶ onDestroy() ä¸ä¼šè¢«è°ƒç”¨ï¼Œåªèƒ½ä¾èµ–ç³»ç»Ÿå®šæ—¶åˆ·æ–°ï¼ˆ5åˆ†é’Ÿï¼‰
        // è®¾ç½®ä¸º 8 åˆ†é’Ÿç¡®ä¿ä¸‹æ¬¡åˆ·æ–°æ—¶ä¸€å®šè§¦å‘æ¸…ç†
        const savedTime = gameState.timestamp || 0;
        const currentTime = Date.now();
        const hoursSinceUpdate = (currentTime - savedTime) / (1000 * 60 * 60);
        
        if (savedTime > 0 && hoursSinceUpdate > 0.133) {  // 0.133 å°æ—¶ = 8 åˆ†é’Ÿ
          hilog.warn(DOMAIN, TAG, 'âš ï¸ æ¸¸æˆæ•°æ®è¿‡æœŸï¼ˆ%.1f å°æ—¶æœªæ›´æ–°ï¼‰ï¼Œæ¸…é™¤çŠ¶æ€', hoursSinceUpdate);
          
          // æ¸…é™¤è¿‡æœŸæ¸¸æˆçŠ¶æ€
          await GameStorage.clearGameState();
          
          // æ˜¾ç¤º"å¼€å§‹æ–°æ¸¸æˆ"
          formData = this.createDefaultFormData();
          hilog.info(DOMAIN, TAG, 'ğŸ“Š å¡ç‰‡æ˜¾ç¤º: å¼€å§‹æ–°æ¸¸æˆï¼ˆæ•°æ®å·²è¿‡æœŸï¼‰');
        } else {
          // æ¸¸æˆçŠ¶æ€æœ‰æ•ˆ
          formData = this.createFormDataFromGameState(gameState);
          hilog.info(DOMAIN, TAG, 'ğŸ“Š å¡ç‰‡æ˜¾ç¤º: ç»§ç»­æ¸¸æˆï¼ˆæ•°æ®æœ‰æ•ˆï¼Œ%.1f å°æ—¶å‰æ›´æ–°ï¼‰', hoursSinceUpdate);
        }
      } else {
        formData = this.createDefaultFormData();
        hilog.info(DOMAIN, TAG, 'ğŸ“Š å¡ç‰‡æ˜¾ç¤º: å¼€å§‹æ–°æ¸¸æˆï¼ˆæ— æ¸¸æˆæ•°æ®ï¼‰');
      }

      // æ›´æ–°å¡ç‰‡
      await formProvider.updateForm(formId, formBindingData.createFormBindingData(formData));
      hilog.info(DOMAIN, TAG, 'âœ… å¡ç‰‡æ›´æ–°æˆåŠŸ');
    } catch (error) {
      hilog.error(DOMAIN, TAG, 'âŒ æ›´æ–°å¡ç‰‡å¤±è´¥: %{public}s', JSON.stringify(error));
    }
  }

  /**
   * åˆ é™¤å¡ç‰‡æ—¶è°ƒç”¨
   */
  onRemoveForm(formId: string): void {
    hilog.info(DOMAIN, TAG, '========== onRemoveForm è°ƒç”¨ ==========');
    hilog.info(DOMAIN, TAG, 'åˆ é™¤å¡ç‰‡ID: %{public}s', formId);
    
    // ä»æŒä¹…åŒ–å­˜å‚¨ç§»é™¤å¡ç‰‡ID
    this.removeFormId(formId);
  }

  /**
   * ä»æŒä¹…åŒ–å­˜å‚¨ç§»é™¤å¡ç‰‡ID
   */
  private async removeFormId(formId: string): Promise<void> {
    try {
      // ğŸ”¥ å…³é”®ï¼šä½¿ç”¨åº”ç”¨çº§åˆ«çš„ contextï¼Œç¡®ä¿ä¸ EntryAbility å…±äº«åŒä¸€å­˜å‚¨
      const appContext = this.context.getApplicationContext();
      const dataPreferences: preferences.Preferences = await preferences.getPreferences(appContext, 'formIds');
      
      // è¯»å–ç°æœ‰çš„å¡ç‰‡IDåˆ—è¡¨
      const formIdsStr: string = await dataPreferences.get('ids', '[]') as string;
      const formIds: Array<string> = JSON.parse(formIdsStr);
      
      hilog.info(DOMAIN, TAG, 'ğŸ“– åˆ é™¤å‰çš„å¡ç‰‡IDåˆ—è¡¨: %{public}s', JSON.stringify(formIds));
      
      // ç§»é™¤ID
      const index: number = formIds.indexOf(formId);
      if (index > -1) {
        formIds.splice(index, 1);
        await dataPreferences.put('ids', JSON.stringify(formIds));
        await dataPreferences.flush();
        hilog.info(DOMAIN, TAG, 'âœ… å¡ç‰‡IDå·²ç§»é™¤: %{public}s å‰©ä½™: %{public}d', formId, formIds.length);
        hilog.info(DOMAIN, TAG, 'ğŸ“‹ åˆ é™¤åçš„å¡ç‰‡IDåˆ—è¡¨: %{public}s', JSON.stringify(formIds));
      } else {
        hilog.warn(DOMAIN, TAG, 'âš ï¸ è¦åˆ é™¤çš„å¡ç‰‡IDä¸å­˜åœ¨: %{public}s', formId);
      }
    } catch (error) {
      hilog.error(DOMAIN, TAG, 'âŒ ç§»é™¤å¡ç‰‡IDå¤±è´¥: %{public}s', JSON.stringify(error));
    }
  }

  /**
   * å¡ç‰‡æ›´æ–°æ—¶è°ƒç”¨
   */
  onUpdateForm(formId: string): void {
    hilog.info(DOMAIN, TAG, '========== onUpdateForm è§¦å‘ï¼ˆç³»ç»Ÿåˆ·æ–°ï¼‰==========');
    hilog.info(DOMAIN, TAG, 'formId: %{public}s', formId);
    
    // ğŸ”¥ ä½¿ç”¨å¸¦è¿‡æœŸæ£€æµ‹çš„åŠ è½½æ–¹æ³•
    this.loadGameStateWithCleanupCheck(formId);
  }

  /**
   * å¡ç‰‡äº‹ä»¶å¤„ç†
   * æ³¨æ„ï¼šSDK 6.0.0(20) ä¸­ FormExtensionContext ä¸æ”¯æŒ startAbility
   * å¡ç‰‡ç‚¹å‡»å¯åŠ¨åº”ç”¨éœ€è¦é€šè¿‡ç³»ç»Ÿé»˜è®¤è¡Œä¸ºå®ç°
   */
  onFormEvent(formId: string, message: string): void {
    hilog.info(DOMAIN, TAG, 'onFormEvent, formId: %{public}s, message: %{public}s', formId, message);
    
    // è§£ææ¶ˆæ¯ï¼ˆæ˜ç¡®ç±»å‹ï¼‰
    try {
      interface MessageParams {
        action: string;
      }
      const params: MessageParams = JSON.parse(message) as MessageParams;
      const action: string = params.action;
      
      if (action === 'launchApp' || action === 'continueGame') {
        hilog.info(DOMAIN, TAG, 'æ”¶åˆ°å¯åŠ¨è¯·æ±‚ï¼Œaction: %{public}s', action);
        // æ³¨æ„ï¼šFormExtensionContext ä¸æ”¯æŒç›´æ¥å¯åŠ¨åº”ç”¨
        // åº”ç”¨å¯åŠ¨éœ€è¦ä¾èµ–ç³»ç»Ÿå¡ç‰‡ç‚¹å‡»çš„é»˜è®¤è¡Œä¸º
      }
    } catch (e) {
      // å¤„ç†é”™è¯¯ï¼ˆcatch ä¸èƒ½æœ‰ç±»å‹æ³¨è§£ï¼‰
      if (e instanceof Error) {
        hilog.error(DOMAIN, TAG, 'è§£ææ¶ˆæ¯å¤±è´¥: %{public}s', e.message);
      } else {
        hilog.error(DOMAIN, TAG, 'æœªçŸ¥é”™è¯¯: %{public}s', String(e));
      }
      
      // è®°å½•åŸå§‹æ¶ˆæ¯
      hilog.info(DOMAIN, TAG, 'åŸå§‹æ¶ˆæ¯: %{public}s', message);
    }
  }

  /**
   * æ ¼å¼åŒ–æ—¶é—´
   */
  private formatTime(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }
}

