import { AbilityConstant, ConfigurationConstant, UIAbility, Want } from '@kit.AbilityKit';
import { hilog } from '@kit.PerformanceAnalysisKit';
import { window } from '@kit.ArkUI';
import { formProvider, formInfo, formBindingData } from '@kit.FormKit';
import { preferences } from '@kit.ArkData';
import font from '@ohos.font';
import { ScreenStateManager } from '../utils/ScreenStateManager';
import { GameStorage, SavedGameState } from '../utils/GameStorage';
import { audioManager } from '../utils/AudioManager';

const DOMAIN = 0x0000;
const TAG = 'EntryAbility';

/**
 * å¡ç‰‡æ•°æ®æ¥å£
 */
interface FormDataContent {
  title: string;
  gameMode: string;
  gridSize: string;
  moveCount: number;
  timeElapsed: string;
  hasActiveGame: boolean;
}

export default class EntryAbility extends UIAbility {
  private targetPage: string = 'pages/EntryPage'; // é»˜è®¤å¯åŠ¨é¡µé¢

  onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
    try {
      this.context.getApplicationContext().setColorMode(ConfigurationConstant.ColorMode.COLOR_MODE_NOT_SET);
    } catch (err) {
      hilog.error(DOMAIN, TAG, 'Failed to set colorMode. Cause: %{public}s', JSON.stringify(err));
    }
    
    // ğŸ”¥ å®˜æ–¹ç¡®è®¤æ–¹æ¡ˆï¼šæ·»åŠ å¯åŠ¨æ—¶é—´æˆ³ï¼Œç”¨äºæ£€æµ‹å†·å¯åŠ¨
    AppStorage.setOrCreate('lastLaunchTime', Date.now());
    hilog.info(DOMAIN, TAG, 'ğŸ• è®°å½•å¯åŠ¨æ—¶é—´: %{public}d', Date.now());
    
    // æ£€æŸ¥æ˜¯å¦ä»å¡ç‰‡å¯åŠ¨
    if (want.parameters) {
      const targetPage = want.parameters['targetPage'] as string;
      if (targetPage) {
        this.targetPage = targetPage;
        hilog.info(DOMAIN, TAG, 'ä»å¡ç‰‡å¯åŠ¨ï¼Œç›®æ ‡é¡µé¢: %{public}s', targetPage);
      }
    }
    
    // ä¿å­˜contextå’ŒresourceManageråˆ°AppStorageï¼Œä¾›å…¨å±€ä½¿ç”¨
    AppStorage.setOrCreate('context', this.context);
    AppStorage.setOrCreate('resourceManager', this.context.resourceManager);
    hilog.info(DOMAIN, TAG, 'Contextå’ŒResourceManagerå·²ä¿å­˜åˆ°AppStorage');
    
    // åˆå§‹åŒ–éŸ³é¢‘ç®¡ç†å™¨
    audioManager.setContext(this.context);
    hilog.info(DOMAIN, TAG, 'AudioManagerå·²åˆå§‹åŒ–');
    
    // æ³¨å†Œè‡ªå®šä¹‰å­—ä½“ï¼ˆå¦‚æœæœ‰ï¼‰
    this.registerCustomFont();
    
    hilog.info(DOMAIN, TAG, '%{public}s', 'Ability onCreate');
  }

  /**
   * æ³¨å†Œè‡ªå®šä¹‰å­—ä½“
   */
  private registerCustomFont(): void {
    try {
      // å¦‚æœæœ‰è‡ªå®šä¹‰å­—ä½“æ–‡ä»¶ï¼Œåœ¨è¿™é‡Œæ³¨å†Œ
      // ä¾‹å¦‚ï¼šentry/src/main/resources/rawfile/fonts/CustomFont.ttf
      // font.registerFontSync({
      //   familyName: 'CustomFont',
      //   familySrc: $rawfile('fonts/CustomFont.ttf')
      // });
      // hilog.info(DOMAIN, TAG, 'è‡ªå®šä¹‰å­—ä½“æ³¨å†ŒæˆåŠŸ');
    } catch (error) {
      hilog.error(DOMAIN, TAG, 'å­—ä½“æ³¨å†Œå¤±è´¥: %{public}s', JSON.stringify(error));
    }
  }

  onDestroy(): void {
    hilog.info(DOMAIN, TAG, '========== ğŸ”´ onDestroy è§¦å‘ï¼ˆåº”ç”¨è¢«é”€æ¯ï¼‰==========');
    
    // ğŸ”¥ å…³é”®ï¼šåº”ç”¨è¢«é”€æ¯æ—¶ï¼Œç«‹å³æ›´æ–°å¡ç‰‡æ˜¾ç¤º"å¼€å§‹æ–°æ¸¸æˆ"
    // å› ä¸ºæ¸¸æˆæ•°æ®å¯èƒ½å·²è¢«æ¸…é™¤æˆ–åº”ç”¨è¢«å¼ºåˆ¶å…³é—­
    this.updateAllFormsOnDestroy();
  }

  /**
   * ğŸ”¥ åº”ç”¨é”€æ¯æ—¶æ›´æ–°æ‰€æœ‰å¡ç‰‡
   * ä½¿ç”¨ fire-and-forget æ¨¡å¼ï¼Œä¸ç­‰å¾…å®Œæˆ
   */
  private updateAllFormsOnDestroy(): void {
    // ä½¿ç”¨å¼‚æ­¥ç«‹å³æ‰§è¡Œå‡½æ•°ï¼ˆä¸é˜»å¡ onDestroyï¼‰
    (async () => {
      try {
        hilog.info(DOMAIN, TAG, 'ğŸ”„ å¼€å§‹æ›´æ–°å¡ç‰‡ï¼ˆåº”ç”¨é”€æ¯ï¼‰');
        
        // ğŸ”¥ å…³é”®ç¬¬ä¸€æ­¥ï¼šæ¸…é™¤ preferences ä¸­çš„æ¸¸æˆçŠ¶æ€
        // é˜²æ­¢å®šæ—¶åˆ·æ–°æ—¶ FormAbility è¯»å–åˆ°æ—§æ•°æ®
        await GameStorage.clearGameState();
        hilog.info(DOMAIN, TAG, 'âœ… æ¸¸æˆçŠ¶æ€å·²æ¸…é™¤ï¼ˆé˜²æ­¢å®šæ—¶åˆ·æ–°è¯»å–æ—§æ•°æ®ï¼‰');
        
        // ç¬¬äºŒæ­¥ï¼šè¯»å–å¡ç‰‡ID
        // ğŸ”¥ å…³é”®ï¼šä½¿ç”¨åº”ç”¨çº§åˆ«çš„ contextï¼Œç¡®ä¿ä¸ FormAbility å…±äº«åŒä¸€å­˜å‚¨
        const appContext = this.context.getApplicationContext();
        const dataPreferences: preferences.Preferences = await preferences.getPreferences(appContext, 'formIds');
        const formIdsStr: string = await dataPreferences.get('ids', '[]') as string;
        const formIds: Array<string> = JSON.parse(formIdsStr);
        
        hilog.info(DOMAIN, TAG, `ğŸ“‹ è¯»å–åˆ° ${formIds.length} ä¸ªå¡ç‰‡`);
        
        if (formIds.length === 0) {
          hilog.warn(DOMAIN, TAG, 'âš ï¸ æ²¡æœ‰å¡ç‰‡ï¼Œè·³è¿‡æ›´æ–°');
          return;
        }
        
        // ç¬¬ä¸‰æ­¥ï¼šåˆ›å»º"å¼€å§‹æ–°æ¸¸æˆ"çš„å¡ç‰‡æ•°æ®
        const formData: FormDataContent = {
          title: 'æ‹¼å›¾æ¸¸æˆ',
          gameMode: 'äº¤æ¢',
          gridSize: '3Ã—3',
          moveCount: 0,
          timeElapsed: '00:00',
          hasActiveGame: false
        };
        
        // ç¬¬å››æ­¥ï¼šæ›´æ–°æ‰€æœ‰å¡ç‰‡
        for (const formId of formIds) {
          try {
            await formProvider.updateForm(formId, formBindingData.createFormBindingData(formData));
            hilog.info(DOMAIN, TAG, `âœ… å¡ç‰‡ ${formId} æ›´æ–°æˆåŠŸ`);
          } catch (error) {
            const err = error as Error;
            hilog.error(DOMAIN, TAG, `âŒ å¡ç‰‡ ${formId} æ›´æ–°å¤±è´¥: ${err.message}`);
          }
        }
        
        hilog.info(DOMAIN, TAG, 'âœ… æ‰€æœ‰å¡ç‰‡æ›´æ–°å®Œæˆï¼ˆåº”ç”¨é”€æ¯ï¼‰');
      } catch (error) {
        const err = error as Error;
        hilog.error(DOMAIN, TAG, `âŒ onDestroy æ›´æ–°å¡ç‰‡å¤±è´¥: ${err.message}`);
      }
    })();
  }

  async onWindowStageCreate(windowStage: window.WindowStage): Promise<void> {
    // Main window is created, set main page for this ability
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onWindowStageCreate');

    try {
      // 1. åˆå§‹åŒ–å±å¹•çŠ¶æ€ç®¡ç†å™¨ï¼ˆç­‰å¾…å®Œæˆï¼‰
      const screenManager = ScreenStateManager.getInstance();
      await screenManager.init(windowStage);
      hilog.info(DOMAIN, TAG, 'âœ… å±å¹•çŠ¶æ€ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ');

      // 2. è®¾ç½®å…¨å±æ¨¡å¼ï¼ˆéšè—çŠ¶æ€æ ï¼‰
      const windowClass = await windowStage.getMainWindow();
      await windowClass.setWindowLayoutFullScreen(true);
      hilog.info(DOMAIN, TAG, 'âœ… å…¨å±æ¨¡å¼è®¾ç½®æˆåŠŸ');

      // 3. åŠ è½½ç›®æ ‡é¡µé¢ï¼ˆæ”¯æŒä»å¡ç‰‡å¯åŠ¨è·³è½¬ï¼‰
      hilog.info(DOMAIN, TAG, 'å‡†å¤‡åŠ è½½é¡µé¢: %{public}s', this.targetPage);
      windowStage.loadContent(this.targetPage, (err) => {
        if (err.code) {
          hilog.error(DOMAIN, 'testTag', 'Failed to load the content. Cause: %{public}s', JSON.stringify(err));
          // å¦‚æœåŠ è½½å¤±è´¥ï¼Œå°è¯•åŠ è½½é»˜è®¤é¡µé¢
          if (this.targetPage !== 'pages/EntryPage') {
            hilog.info(DOMAIN, TAG, 'ç›®æ ‡é¡µé¢åŠ è½½å¤±è´¥ï¼Œå›é€€åˆ°é»˜è®¤é¡µé¢');
            windowStage.loadContent('pages/EntryPage', (err2) => {
              if (err2.code) {
                hilog.error(DOMAIN, TAG, 'é»˜è®¤é¡µé¢ä¹ŸåŠ è½½å¤±è´¥: %{public}s', JSON.stringify(err2));
              }
            });
          }
          return;
        }
        hilog.info(DOMAIN, 'testTag', 'âœ… é¡µé¢åŠ è½½æˆåŠŸ: %{public}s', this.targetPage);
        // é‡ç½®ç›®æ ‡é¡µé¢ä¸ºé»˜è®¤å€¼
        this.targetPage = 'pages/EntryPage';
      });
    } catch (err) {
      hilog.error(DOMAIN, TAG, 'âŒ åˆå§‹åŒ–å¤±è´¥: %{public}s', JSON.stringify(err));
    }
  }

  onWindowStageDestroy(): void {
    // Main window is destroyed, release UI related resources
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onWindowStageDestroy');
    
    // æ¸…ç†å±å¹•çŠ¶æ€ç®¡ç†å™¨
    const screenManager = ScreenStateManager.getInstance();
    screenManager.destroy();
  }

  onForeground(): void {
    // Ability has brought to foreground
    hilog.info(DOMAIN, 'testTag', '%{public}s', 'Ability onForeground');
    
    // æ¢å¤èƒŒæ™¯éŸ³ä¹æ’­æ”¾
    audioManager.resumeBGM();
    hilog.info(DOMAIN, TAG, 'åº”ç”¨å›åˆ°å‰å°ï¼Œæ¢å¤éŸ³ä¹æ’­æ”¾');
  }

  onNewWant(want: Want, launchParam: AbilityConstant.LaunchParam): void {
    // å¤„ç†å·²è¿è¡Œåº”ç”¨è¢«å¡ç‰‡å†æ¬¡å”¤èµ·çš„æƒ…å†µ
    hilog.info(DOMAIN, TAG, '========== onNewWant è§¦å‘ ==========');
    hilog.info(DOMAIN, TAG, 'want.parameters: %{public}s', JSON.stringify(want.parameters));
    
    if (want.parameters) {
      const targetPage = want.parameters['targetPage'] as string;
      if (targetPage) {
        hilog.info(DOMAIN, TAG, 'ğŸ¯ å¡ç‰‡å”¤èµ·åº”ç”¨ï¼Œç›®æ ‡é¡µé¢: %{public}s', targetPage);
        
        // ğŸ”¥ å…³é”®ï¼šä¿å­˜åˆ° AppStorageï¼Œè®©å½“å‰é¡µé¢å“åº”è·³è½¬
        AppStorage.setOrCreate('widgetTargetPage', targetPage);
        AppStorage.setOrCreate('widgetTargetPageTimestamp', Date.now());  // æ·»åŠ æ—¶é—´æˆ³ç¡®ä¿è§¦å‘æ›´æ–°
        
        hilog.info(DOMAIN, TAG, 'âœ… ç›®æ ‡é¡µé¢å·²ä¿å­˜åˆ° AppStorage');
      } else {
        hilog.warn(DOMAIN, TAG, 'âš ï¸ æœªæ‰¾åˆ° targetPage å‚æ•°');
      }
    } else {
      hilog.warn(DOMAIN, TAG, 'âš ï¸ want.parameters ä¸ºç©º');
    }
  }

  onBackground(): void {
    // Ability has back to background
    hilog.info(DOMAIN, TAG, '========== onBackground è§¦å‘ ==========');
    
    // ä¿å­˜å½“å‰æ’­æ”¾ä½ç½®
    audioManager.savePlaybackPosition();
    hilog.info(DOMAIN, TAG, 'å·²ä¿å­˜éŸ³ä¹æ’­æ”¾ä½ç½®');
    
    // ğŸ”¥ å…³é”®ï¼šä¸»åŠ¨æ›´æ–°æ‰€æœ‰å¡ç‰‡ï¼Œå®ç°å®æ—¶åŒæ­¥
    this.updateAllForms();
  }

  /**
   * æ›´æ–°æ‰€æœ‰æœåŠ¡å¡ç‰‡
   * ğŸ”¥ å¼ºç¡¬æ‰‹æ®µï¼šä¼˜å…ˆä» AppStorageï¼ˆå†…å­˜ï¼‰è¯»å–å®æ—¶çŠ¶æ€ï¼Œfallback åˆ° preferences
   */
  private async updateAllForms(): Promise<void> {
    try {
      hilog.info(DOMAIN, TAG, '========== ğŸ”„ å¼€å§‹æ›´æ–°æ‰€æœ‰å¡ç‰‡ ==========');
      
      // ğŸ”¥ å…³é”®ï¼šä½¿ç”¨åº”ç”¨çº§åˆ«çš„ contextï¼Œç¡®ä¿ä¸ FormAbility å…±äº«åŒä¸€å­˜å‚¨
      const appContext = this.context.getApplicationContext();
      const dataPreferences: preferences.Preferences = await preferences.getPreferences(appContext, 'formIds');
      const formIdsStr: string = await dataPreferences.get('ids', '[]') as string;
      const formIds: Array<string> = JSON.parse(formIdsStr);
      
      hilog.info(DOMAIN, TAG, `ğŸ“‹ è¯»å–åˆ° ${formIds.length} ä¸ªå¡ç‰‡ID: ${JSON.stringify(formIds)}`);
      
      if (formIds.length === 0) {
        hilog.warn(DOMAIN, TAG, 'âš ï¸ æ²¡æœ‰å·²æ·»åŠ çš„å¡ç‰‡ï¼Œè·³è¿‡æ›´æ–°');
        hilog.info(DOMAIN, TAG, 'ğŸ’¡ æç¤ºï¼šè¯·å…ˆé•¿æŒ‰åº”ç”¨å›¾æ ‡æ·»åŠ æœåŠ¡å¡ç‰‡åˆ°æ¡Œé¢');
        return;
      }
      
      // ğŸ”¥ å…³é”®ï¼šä¼˜å…ˆä» AppStorage è¯»å–å®æ—¶çŠ¶æ€ï¼ˆé›¶å»¶è¿Ÿï¼‰
      let gameState: SavedGameState | null = AppStorage.get<SavedGameState>('currentGameState') || null;
      
      if (gameState) {
        hilog.info(DOMAIN, TAG, 'âš¡ ä» AppStorage è¯»å–åˆ°å®æ—¶æ¸¸æˆçŠ¶æ€');
        hilog.info(DOMAIN, TAG, `   - æ¨¡å¼: ${gameState.gameMode}`);
        hilog.info(DOMAIN, TAG, `   - æ­¥æ•°: ${gameState.moveCount}`);
        hilog.info(DOMAIN, TAG, `   - ç”¨æ—¶: ${gameState.timeElapsed}ç§’`);
        hilog.info(DOMAIN, TAG, `   - è¿›è¡Œä¸­: ${gameState.isPlaying}`);
      } else {
        // Fallback: ä» preferences è¯»å–æŒä¹…åŒ–çŠ¶æ€
        hilog.info(DOMAIN, TAG, 'ğŸ’¾ AppStorageæ— æ•°æ®ï¼Œä» preferences è¯»å–...');
        gameState = await GameStorage.loadGameState();
        
        if (gameState) {
          hilog.info(DOMAIN, TAG, 'ğŸ“¦ ä» preferences è¯»å–åˆ°æ¸¸æˆçŠ¶æ€');
        } else {
          hilog.info(DOMAIN, TAG, 'âŒ æ— æ¸¸æˆçŠ¶æ€');
        }
      }
      
      // ğŸ”¥ æ ¹æ®æ¸¸æˆçŠ¶æ€åˆ›å»ºå¡ç‰‡æ•°æ®
      let formData: FormDataContent;
      
      if (gameState && gameState.isPlaying) {
        // æœ‰è¿›è¡Œä¸­çš„æ¸¸æˆ
        const minutes = Math.floor(gameState.timeElapsed / 60);
        const seconds = gameState.timeElapsed % 60;
        const timeStr = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // ğŸ”¥ å°†è‹±æ–‡æ¨¡å¼è½¬æ¢ä¸ºä¸­æ–‡
        const gameModeChinese = gameState.gameMode === 'swap' ? 'äº¤æ¢' : 'æ»‘åŠ¨';
        
        formData = {
          title: 'æ‹¼å›¾æ¸¸æˆ',
          gameMode: gameModeChinese,
          gridSize: `${gameState.gridSize}Ã—${gameState.gridSize}`,
          moveCount: gameState.moveCount,
          timeElapsed: timeStr,
          hasActiveGame: true
        };
        
        hilog.info(DOMAIN, TAG, 'ğŸ“Š å¡ç‰‡å°†æ˜¾ç¤º: ç»§ç»­æ¸¸æˆ / ä¸»é¢˜');
      } else {
        // æ— æ¸¸æˆæˆ–æ¸¸æˆæœªè¿›è¡Œä¸­
        formData = {
          title: 'æ‹¼å›¾æ¸¸æˆ',
          gameMode: 'äº¤æ¢',
          gridSize: '3Ã—3',
          moveCount: 0,
          timeElapsed: '00:00',
          hasActiveGame: false
        };
        
        hilog.info(DOMAIN, TAG, 'ğŸ“Š å¡ç‰‡å°†æ˜¾ç¤º: å¼€å§‹æ–°æ¸¸æˆ');
      }
      
      // éå†æ‰€æœ‰å¡ç‰‡å¹¶æ›´æ–°
      for (const formId of formIds) {
        hilog.info(DOMAIN, TAG, `ğŸ”„ æ›´æ–°å¡ç‰‡: ${formId}`);
        
        try {
          await formProvider.updateForm(formId, formBindingData.createFormBindingData(formData));
          hilog.info(DOMAIN, TAG, `âœ… å¡ç‰‡ ${formId} æ›´æ–°æˆåŠŸ`);
        } catch (updateError) {
          const err = updateError as Error;
          hilog.error(DOMAIN, TAG, `âŒ å¡ç‰‡ ${formId} æ›´æ–°å¤±è´¥ï¼š${JSON.stringify(updateError)}`);
          hilog.error(DOMAIN, TAG, `   è¯¦ç»†ä¿¡æ¯ï¼š%{public}s`, err.message || 'æœªçŸ¥é”™è¯¯');
        }
      }
      
      hilog.info(DOMAIN, TAG, '========== âœ… æ‰€æœ‰å¡ç‰‡æ›´æ–°å®Œæˆ ==========');
    } catch (error) {
      hilog.error(DOMAIN, TAG, 'âŒ æ›´æ–°å¡ç‰‡è¿‡ç¨‹å‡ºé”™: %{public}s', JSON.stringify(error));
    }
  }

  /**
   * åˆ›å»ºå¡ç‰‡æ•°æ®
   */
  private createFormData(gameState: SavedGameState | null): FormDataContent {
    if (gameState && gameState.isPlaying) {
      // æœ‰è¿›è¡Œä¸­çš„æ¸¸æˆ
      const data: FormDataContent = {
        title: 'æ‹¼å›¾æ¸¸æˆ',
        gameMode: gameState.gameMode === 'swap' ? 'äº¤æ¢æ¨¡å¼' : 'åå®¹é“',
        gridSize: `${gameState.gridSize}Ã—${gameState.gridSize}`,
        moveCount: gameState.moveCount,
        timeElapsed: this.formatTime(gameState.timeElapsed),
        hasActiveGame: true
      };
      return data;
    } else {
      // æ— è¿›è¡Œä¸­çš„æ¸¸æˆ
      const data: FormDataContent = {
        title: 'æ‹¼å›¾æ¸¸æˆ',
        gameMode: 'äº¤æ¢æ¨¡å¼',
        gridSize: '3Ã—3',
        moveCount: 0,
        timeElapsed: '00:00',
        hasActiveGame: false
      };
      return data;
    }
  }

  /**
   * æ ¼å¼åŒ–æ—¶é—´
   */
  private formatTime(seconds: number): string {
    const mins: number = Math.floor(seconds / 60);
    const secs: number = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }
}