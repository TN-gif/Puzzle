import { router } from '@kit.ArkUI';
import { picker } from '@kit.CoreFileKit';
import { DifficultySelector } from '../components/DifficultySelector';
import { ImageSelector } from '../components/ImageSelector';
import { GameModeSelector } from '../components/GameModeSelector';
import { NetworkImageSelector } from '../components/NetworkImageSelector';
import { GameConstants } from '../constants/GameConstants';
import { ImageAssets } from '../constants/ImageAssets';

/**
 * ä¸»é¡µï¼šéš¾åº¦é€‰æ‹©ã€å›¾ç‰‡é€‰æ‹©
 */
@Entry
@Component
struct HomePage {
  @State selectedMode: string = GameConstants.GAME_MODE.SWAP;  // é»˜è®¤è‡ªç”±äº¤æ¢æ¨¡å¼
  @State selectedDifficulty: number = 3;  // é»˜è®¤ç®€å•éš¾åº¦
  @State selectedImageId: number = 1;     // é»˜è®¤ç¬¬ä¸€å¼ å›¾ç‰‡
  @State customImageUri: string = '';     // è‡ªå®šä¹‰å›¾ç‰‡URI
  @State networkImageUrl: string = '';    // ç½‘ç»œå›¾ç‰‡URL

  // ç½‘ç»œå›¾ç‰‡é€‰æ‹©å¯¹è¯æ¡†
  private networkImageDialogController: CustomDialogController = new CustomDialogController({
    builder: NetworkImageSelector({
      onImageSelected: (imageUrl: string) => {
        this.networkImageUrl = imageUrl;
        this.selectedImageId = -2;  // æ ‡è®°ä¸ºç½‘ç»œå›¾ç‰‡
        console.info('é€‰æ‹©çš„ç½‘ç»œå›¾ç‰‡URL:', imageUrl);
      }
    }),
    autoCancel: true,
    customStyle: true
  });

  // ä»Žç›¸å†Œé€‰æ‹©å›¾ç‰‡
  async selectFromGallery(): Promise<void> {
    try {
      const photoSelectOptions = new picker.PhotoSelectOptions();
      photoSelectOptions.maxSelectNumber = 1;

      const photoPicker = new picker.PhotoViewPicker();
      const result = await photoPicker.select(photoSelectOptions);

      if (result && result.photoUris && result.photoUris.length > 0) {
        this.customImageUri = result.photoUris[0];
        this.selectedImageId = -1;  // æ ‡è®°ä¸ºè‡ªå®šä¹‰å›¾ç‰‡
        console.info('é€‰æ‹©çš„å›¾ç‰‡URI:', this.customImageUri);
      }
    } catch (error) {
      console.error('é€‰æ‹©å›¾ç‰‡å¤±è´¥:', error);
    }
  }

  // å¼€å§‹æ¸¸æˆ
  startGame(): void {
    // å‡†å¤‡å‚æ•°
    let imageResource: Resource | string;
    let isCustomImage = false;
    let isNetworkImage = false;
    
    if (this.selectedImageId === -2 && this.networkImageUrl) {
      // ä½¿ç”¨ç½‘ç»œå›¾ç‰‡
      imageResource = this.networkImageUrl;
      isNetworkImage = true;
    } else if (this.selectedImageId === -1 && this.customImageUri) {
      // ä½¿ç”¨ç›¸å†Œå›¾ç‰‡
      imageResource = this.customImageUri;
      isCustomImage = true;
    } else {
      // ä½¿ç”¨é¢„è®¾å›¾ç‰‡
      const presetImage = ImageAssets.PRESET_IMAGES.find(img => img.id === this.selectedImageId);
      imageResource = presetImage ? presetImage.resource : ImageAssets.PRESET_IMAGES[0].resource;
    }

    // è·³è½¬åˆ°æ¸¸æˆé¡µ
    try {
      router.pushUrl({
        url: 'pages/GamePage',
        params: {
          gameMode: this.selectedMode,
          gridSize: this.selectedDifficulty,
          imageResource: imageResource,
          isCustomImage: isCustomImage,
          isNetworkImage: isNetworkImage
        }
      });
    } catch (err) {
      console.error('è·¯ç”±è·³è½¬å¤±è´¥:', err);
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜åŒº
      Column({ space: 8 }) {
        Text('ðŸ§©')
          .fontSize(48)

        Text('æ‹¼å›¾æ¸¸æˆ')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor(GameConstants.COLORS.TEXT)

        Text('è‡ªç”±äº¤æ¢ & æ•°å­—åŽå®¹é“')
          .fontSize(16)
          .fontColor('#999999')
      }
      .width('100%')
      .padding({ top: 40, bottom: 20 })

      // æ»šåŠ¨åŒºåŸŸ
      Scroll() {
        Column({ space: 16 }) {
          // æ¨¡å¼é€‰æ‹©
          GameModeSelector({ selectedMode: $selectedMode })

          // éš¾åº¦é€‰æ‹©
          DifficultySelector({ selectedDifficulty: $selectedDifficulty })

          // å›¾ç‰‡é€‰æ‹©
          ImageSelector({ 
            selectedImageId: $selectedImageId,
            onCustomImageSelect: () => {
              this.selectFromGallery();
            }
          })

          // ç½‘ç»œå›¾ç‰‡æŒ‰é’®
          Button() {
            Row({ space: 8 }) {
              Text('ðŸŒ')
                .fontSize(20)
              Text(this.networkImageUrl ? 'å·²é€‰æ‹©ç½‘ç»œå›¾ç‰‡' : 'ä»Žç½‘ç»œæœç´¢å›¾ç‰‡')
                .fontSize(16)
            }
          }
          .width('100%')
          .height(50)
          .backgroundColor(this.selectedImageId === -2 ? '#E6F7FF' : Color.White)
          .fontColor(GameConstants.COLORS.PRIMARY)
          .border({ 
            width: this.selectedImageId === -2 ? 2 : 1, 
            color: GameConstants.COLORS.PRIMARY 
          })
          .borderRadius(12)
          .onClick(() => {
            this.networkImageDialogController = new CustomDialogController({
              builder: NetworkImageSelector({
                onImageSelected: (imageUrl: string) => {
                  this.networkImageUrl = imageUrl;
                  this.selectedImageId = -2;
                }
              }),
              autoCancel: true,
              customStyle: true
            });
            this.networkImageDialogController.open();
          })

          // å¼€å§‹æ¸¸æˆæŒ‰é’®
          Button('å¼€å§‹æ¸¸æˆ')
            .width('100%')
            .height(50)
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .backgroundColor(GameConstants.COLORS.PRIMARY)
            .borderRadius(12)
            .margin({ top: 20, bottom: 20 })
            .onClick(() => {
              this.startGame();
            })
        }
        .padding(16)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Auto)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(GameConstants.COLORS.BACKGROUND)
  }
}

