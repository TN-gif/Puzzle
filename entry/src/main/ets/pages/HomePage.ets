import { router } from '@kit.ArkUI';
import { picker } from '@kit.CoreFileKit';
import { DifficultySelector } from '../components/DifficultySelector';
import { ImageSelector } from '../components/ImageSelector';
import { GameModeSelector } from '../components/GameModeSelector';
import { NetworkImageSelector } from '../components/NetworkImageSelector';
import { GameConstants, Colors } from '../constants/GameConstants';
import { ImageAssets } from '../constants/ImageAssets';

/**
 * ä¸»é¡µï¼šéš¾åº¦é€‰æ‹©ã€å›¾ç‰‡é€‰æ‹©
 */
@Entry
@Component
struct HomePage {
  @State selectedMode: string = GameConstants.GAME_MODE.SWAP;  // é»˜è®¤è‡ªç”±äº¤æ¢æ¨¡å¼
  @State selectedDifficulty: number = 3;  // é»˜è®¤ç®€å•éš¾åº¦
  @State selectedImageId: number = 1;     // é»˜è®¤ç¬¬ä¸€å¼ å›¾ç‰‡
  @State customImageUri: string = '';     // è‡ªå®šä¹‰å›¾ç‰‡URI
  @State networkImageUrl: string = '';    // ç½‘ç»œå›¾ç‰‡URL

  // ç½‘ç»œå›¾ç‰‡é€‰æ‹©å¯¹è¯æ¡†
  private networkImageDialogController: CustomDialogController = new CustomDialogController({
    builder: NetworkImageSelector({
      onImageSelected: (imageUrl: string) => {
        this.networkImageUrl = imageUrl;
        this.selectedImageId = -2;  // æ ‡è®°ä¸ºç½‘ç»œå›¾ç‰‡
        console.info('é€‰æ‹©çš„ç½‘ç»œå›¾ç‰‡URL:', imageUrl);
      }
    }),
    autoCancel: true,
    customStyle: true
  });

  // ä»Žç›¸å†Œé€‰æ‹©å›¾ç‰‡
  async selectFromGallery(): Promise<void> {
    try {
      const photoSelectOptions = new picker.PhotoSelectOptions();
      photoSelectOptions.maxSelectNumber = 1;

      const photoPicker = new picker.PhotoViewPicker();
      const result = await photoPicker.select(photoSelectOptions);

      if (result && result.photoUris && result.photoUris.length > 0) {
        this.customImageUri = result.photoUris[0];
        this.selectedImageId = -1;  // æ ‡è®°ä¸ºè‡ªå®šä¹‰å›¾ç‰‡
        console.info('é€‰æ‹©çš„å›¾ç‰‡URI:', this.customImageUri);
      }
    } catch (error) {
      console.error('é€‰æ‹©å›¾ç‰‡å¤±è´¥:', error);
    }
  }

  // å¼€å§‹æ¸¸æˆ
  startGame(): void {
    // å‡†å¤‡å‚æ•°
    let imageResource: Resource | string;
    let isCustomImage = false;
    let isNetworkImage = false;
    
    if (this.selectedImageId === -2 && this.networkImageUrl) {
      // ä½¿ç”¨ç½‘ç»œå›¾ç‰‡
      imageResource = this.networkImageUrl;
      isNetworkImage = true;
    } else if (this.selectedImageId === -1 && this.customImageUri) {
      // ä½¿ç”¨ç›¸å†Œå›¾ç‰‡
      imageResource = this.customImageUri;
      isCustomImage = true;
    } else {
      // ä½¿ç”¨é¢„è®¾å›¾ç‰‡
      const presetImage = ImageAssets.PRESET_IMAGES.find(img => img.id === this.selectedImageId);
      imageResource = presetImage ? presetImage.resource : ImageAssets.PRESET_IMAGES[0].resource;
    }

    // è·³è½¬åˆ°æ¸¸æˆé¡µ
    try {
      router.pushUrl({
        url: 'pages/GamePage',
        params: {
          gameMode: this.selectedMode,
          gridSize: this.selectedDifficulty,
          imageResource: imageResource,
          isCustomImage: isCustomImage,
          isNetworkImage: isNetworkImage
        }
      });
    } catch (err) {
      console.error('è·¯ç”±è·³è½¬å¤±è´¥:', err);
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜åŒº - è§å…‰ç§‘æŠ€é£Ž
      Column({ space: 8 }) {
        // è£…é¥°æ€§è§å…‰æ¡çº¹
        Row({ space: 8 }) {
          Text('â”')
            .fontSize(24)
            .fontColor(Colors.ACCENT_PRIMARY)
            .opacity(0.6)
          Text('ðŸ§©')
            .fontSize(56)
          Text('â”')
            .fontSize(24)
            .fontColor(Colors.ACCENT_PRIMARY)
            .opacity(0.6)
        }

        Text('æ‹¼å›¾æ¸¸æˆ')
          .fontSize(40)
          .fontWeight(FontWeight.Bold)
          .fontColor(Colors.ACCENT_PRIMARY)
          .letterSpacing(2)
          .shadow({
            radius: GameConstants.GLOW_EFFECT.PRIMARY.RADIUS,
            color: GameConstants.GLOW_EFFECT.PRIMARY.COLOR,
            offsetX: 0,
            offsetY: 0
          })

        Text('PUZZLE GAME')
          .fontSize(14)
          .fontColor(Colors.TEXT_DISABLED)
          .fontWeight(FontWeight.Medium)
          .letterSpacing(4)
          .opacity(0.7)

        Text('è§å…‰ç§‘æŠ€é£Ž Â· æŒ‘æˆ˜ä½ çš„æ™ºåŠ›æžé™')
          .fontSize(15)
          .fontColor(Colors.TEXT_SECONDARY)
          .fontWeight(FontWeight.Medium)
          .margin({ top: 4 })
      }
      .width('100%')
      .padding({ top: 40, bottom: 28 })

      // æ»šåŠ¨åŒºåŸŸ
      Scroll() {
        Column({ space: 16 }) {
          // æ¨¡å¼é€‰æ‹©
          GameModeSelector({ selectedMode: $selectedMode })

          // éš¾åº¦é€‰æ‹©
          DifficultySelector({ selectedDifficulty: $selectedDifficulty })

          // å›¾ç‰‡é€‰æ‹©
          ImageSelector({ 
            selectedImageId: $selectedImageId,
            onCustomImageSelect: () => {
              this.selectFromGallery();
            }
          })

          // ç½‘ç»œå›¾ç‰‡æŒ‰é’® - è§å…‰ç§‘æŠ€é£Ž
          Button() {
            Row({ space: 10 }) {
              Text('ðŸŒ')
                .fontSize(22)
              Column({ space: 2 }) {
                Text(this.networkImageUrl ? 'âœ“ å·²é€‰æ‹©ç½‘ç»œå›¾ç‰‡' : 'ä»Žç½‘ç»œæœç´¢å›¾ç‰‡')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                if (this.selectedImageId === -2) {
                  Text('ç‚¹å‡»æ›´æ¢å›¾ç‰‡')
                    .fontSize(12)
                    .fontColor(Colors.TEXT_DISABLED)
                }
              }
              .alignItems(HorizontalAlign.Start)
            }
          }
          .width('100%')
          .height(this.selectedImageId === -2 ? 64 : 56)
          .backgroundColor(this.selectedImageId === -2 ? Colors.SURFACE_ELEVATED : Colors.SURFACE)
          .fontColor(this.selectedImageId === -2 ? Colors.ACCENT_PRIMARY : Colors.TEXT_SECONDARY)
          .border({ 
            width: this.selectedImageId === -2 ? 2 : 1, 
            color: this.selectedImageId === -2 ? Colors.ACCENT_PRIMARY : Colors.TEXT_DISABLED
          })
          .borderRadius(GameConstants.BORDER_RADIUS.MEDIUM)
          .shadow({
            radius: this.selectedImageId === -2 ? GameConstants.GLOW_EFFECT.PRIMARY.RADIUS : 0,
            color: GameConstants.GLOW_EFFECT.PRIMARY.COLOR,
            offsetX: 0,
            offsetY: 0
          })
          .onClick(() => {
            this.networkImageDialogController = new CustomDialogController({
              builder: NetworkImageSelector({
                onImageSelected: (imageUrl: string) => {
                  this.networkImageUrl = imageUrl;
                  this.selectedImageId = -2;
                }
              }),
              autoCancel: true,
              customStyle: true
            });
            this.networkImageDialogController.open();
          })

          // å¼€å§‹æ¸¸æˆæŒ‰é’® - è§å…‰ç§‘æŠ€é£Žï¼ˆå¸¦éœ“è™¹è¾‰å…‰ï¼‰
          Button() {
            Row({ space: 12 }) {
              Text('ðŸŽ®')
                .fontSize(24)
              Text('å¼€å§‹æ¸¸æˆ')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .letterSpacing(2)
              Text('â–¶')
                .fontSize(16)
            }
          }
          .width('100%')
          .height(64)
          .backgroundColor(Colors.ACCENT_PRIMARY)
          .fontColor(Colors.BACKGROUND_BASE)
          .borderRadius(GameConstants.BORDER_RADIUS.PILL)
          .shadow({
            radius: GameConstants.GLOW_EFFECT.PRIMARY.RADIUS * 1.5,
            color: GameConstants.GLOW_EFFECT.PRIMARY.COLOR,
            offsetX: 0,
            offsetY: 0
          })
          .margin({ top: 32, bottom: 24 })
          .onClick(() => {
            this.startGame();
          })
        }
        .padding(16)
      }
      .layoutWeight(1)
      .scrollBar(BarState.Auto)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Colors.BACKGROUND_BASE)
  }
}

