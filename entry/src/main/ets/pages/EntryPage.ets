import { router, font } from '@kit.ArkUI';
import { ScreenState, ScreenStateManager } from '../utils/ScreenStateManager';
import { DesignConstants } from '../constants/DesignConstants';
import { audioManager } from '../utils/AudioManager';
import { SoundButton } from '../components/SoundButton';

/**
 * ä½ç½®æŽ¥å£
 */
interface Position {
  x: number;
  y: number;
}

/**
 * è¿›å…¥é¡µé¢
 * åº”ç”¨å¯åŠ¨åŽçš„ç¬¬ä¸€ä¸ªé¡µé¢
 */
@Entry
@Component
struct EntryPage {
  @State screenState: ScreenState = ScreenState.TRIPLE;
  private screenManager: ScreenStateManager = ScreenStateManager.getInstance();
  
  // è‡ªå®šä¹‰å­—ä½“æ³¨å†Œ
  @State fontLoaded: boolean = false;
  
  // ðŸ”¥ ç›‘å¬å¡ç‰‡è·³è½¬è¯·æ±‚
  @StorageProp('widgetTargetPage') widgetTargetPage: string = '';
  @StorageProp('widgetTargetPageTimestamp') widgetTargetPageTimestamp: number = 0;
  @State private lastProcessedTimestamp: number = 0;
  
  aboutToAppear() {
    // ç›‘å¬å±å¹•çŠ¶æ€å˜åŒ–
    this.screenManager.addListener((state: ScreenState) => {
      console.info(`[EntryPage] ðŸ”” å±å¹•çŠ¶æ€å˜åŒ–: ${this.screenState} â†’ ${state}`);
      this.screenState = state;
    });
    this.screenState = this.screenManager.getCurrentState();
    console.info(`[EntryPage] âœ… åˆå§‹å±å¹•çŠ¶æ€: ${this.screenState}`);

    // æ³¨å†Œè‡ªå®šä¹‰å­—ä½“
    font.registerFont({
      familyName: 'Muyao-Softbrush',
      familySrc: `/resources/rawfile/${DesignConstants.CUSTOM_FONT_PATH}`
    });
    this.fontLoaded = true;
    
    // æ’­æ”¾ä¸»é¢˜èƒŒæ™¯éŸ³ä¹
    audioManager.playBGM('music/ä¸»é¢˜èƒŒæ™¯éŸ³ä¹.mp3');
    console.info('[EntryPage] å¼€å§‹æ’­æ”¾ä¸»é¢˜èƒŒæ™¯éŸ³ä¹');
    
    // ðŸ”¥ æ£€æŸ¥æ˜¯å¦æœ‰å¡ç‰‡è·³è½¬è¯·æ±‚
    this.checkWidgetNavigation();
  }
  
  /**
   * ðŸ”¥ å¤„ç†å¡ç‰‡è·³è½¬è¯·æ±‚ï¼ˆå®˜æ–¹å»ºè®®ï¼šæ·»åŠ æ—¶é—´æˆ³æ ¡éªŒï¼‰
   */
  private checkWidgetNavigation(): void {
    // ðŸ”¥ å®˜æ–¹å»ºè®®ï¼šæ—¶é—´æˆ³æ ¡éªŒï¼Œé¿å…é‡å¤è·³è½¬
    if (this.widgetTargetPage && 
        this.widgetTargetPageTimestamp > 0 && 
        this.widgetTargetPageTimestamp !== this.lastProcessedTimestamp) {
      
      console.info(`[EntryPage] ðŸŽ¯ æ£€æµ‹åˆ°å¡ç‰‡è·³è½¬è¯·æ±‚:`);
      console.info(`[EntryPage]   - ç›®æ ‡é¡µé¢: ${this.widgetTargetPage}`);
      console.info(`[EntryPage]   - è¯·æ±‚æ—¶é—´æˆ³: ${this.widgetTargetPageTimestamp}`);
      
      // ðŸ”¥ å…³é”®ï¼šå…ˆç”¨å±€éƒ¨å˜é‡ä¿å­˜ç›®æ ‡é¡µé¢ï¼ˆé˜²æ­¢æ¸…ç©ºAppStorageåŽä¸¢å¤±ï¼‰
      const targetPageToNavigate = this.widgetTargetPage;
      
      // è®°å½•å·²å¤„ç†çš„æ—¶é—´æˆ³
      this.lastProcessedTimestamp = this.widgetTargetPageTimestamp;
      
      // æ¸…é™¤æ ‡è®°ï¼Œé¿å…é‡å¤è·³è½¬
      AppStorage.setOrCreate('widgetTargetPage', '');
      AppStorage.setOrCreate('widgetTargetPageTimestamp', 0);
      
      // æ‰§è¡Œè·³è½¬
      setTimeout(() => {
        router.pushUrl({
          url: targetPageToNavigate
        }).then(() => {
          console.info(`[EntryPage] âœ… å¡ç‰‡è·³è½¬æˆåŠŸ: ${targetPageToNavigate}`);
        }).catch((err: Error) => {
          console.error(`[EntryPage] âŒ å¡ç‰‡è·³è½¬å¤±è´¥: ${err.message}`);
        });
      }, 100);
    }
  }
  
  /**
   * ç›‘å¬ widgetTargetPageTimestamp å˜åŒ–
   */
  onPageShow() {
    this.checkWidgetNavigation();
    
    // ç¡®ä¿éŸ³ä¹æ’­æ”¾
    audioManager.resumeBGM();
  }

  aboutToDisappear() {
    // ç§»é™¤ç›‘å¬å™¨
    this.screenManager.removeListener((state: ScreenState) => {
      this.screenState = state;
    });
  }

  // å¼€å§‹æ‹¼å›¾æŒ‰é’®ç‚¹å‡»
  startPuzzle() {
    router.pushUrl({
      url: 'pages/ThemeSelectionPage'
    }).catch((err: Error) => {
      console.error('è·³è½¬å¤±è´¥:', err);
    });
  }

  // ä¸‰å±å¸ƒå±€ï¼ˆæ‰€æœ‰å‚æ•°å†™æ­»ï¼‰
  @Builder
  buildTripleLayout() {
    Stack() {
      // èƒŒæ™¯å›¾ç‰‡
      Image($rawfile('images/ä¸»é¡µé¢èƒŒæ™¯å›¾.jpg'))
        .width('100%')
        .height('100%')
        .objectFit(ImageFit.Cover)

      // å£°éŸ³æŽ§åˆ¶æŒ‰é’®ï¼ˆå³ä¸Šè§’ï¼‰
      SoundButton({ buttonSize: 60, iconSize: 32 })
        .position({ x: 1020, y: 26 })

      // å¼€å§‹æ‹¼å›¾æŒ‰é’®ï¼ˆå†™æ­»æ‰€æœ‰å‚æ•°ï¼‰
      Button() {
        Text('å¼€å§‹æ‹¼å›¾')
          .fontFamily('Muyao-Softbrush')
          .fontSize(48)
          .fontColor('#000000')
      }
      .width(254)
      .height(74)
      .backgroundColor('rgba(255, 255, 255, 0.91)')
      .borderRadius(25)
      .border({
        width: 4,
        color: Color.Transparent
      })
      .position({ x: 426, y: 652 })
      .onClick(() => {
        this.startPuzzle();
      })
    }
    .width(1107)
    .height(776)
  }

  // åŒå±å¸ƒå±€ï¼ˆæ‰€æœ‰å‚æ•°å†™æ­»ï¼‰
  @Builder
  buildDoubleLayout() {
    Stack() {
      // èƒŒæ™¯å›¾ç‰‡
      Image($rawfile('images/ä¸»é¡µé¢èƒŒæ™¯å›¾.jpg'))
        .width('100%')
        .height('100%')
        .objectFit(ImageFit.Cover)

      // å£°éŸ³æŽ§åˆ¶æŒ‰é’®ï¼ˆå³ä¸Šè§’ï¼‰
      SoundButton({ buttonSize: 60, iconSize: 32 })
        .position({ x: 625, y: 22 })

      // å¼€å§‹æ‹¼å›¾æŒ‰é’®ï¼ˆå†™æ­»æ‰€æœ‰å‚æ•°ï¼‰
      Button() {
        Text('å¼€å§‹æ‹¼å›¾')
          .fontFamily('Muyao-Softbrush')
          .fontSize(48)
          .fontColor('#000000')
      }
      .width(254)
      .height(74)
      .backgroundColor('rgba(255, 255, 255, 0.91)')
      .borderRadius(25)
      .border({
        width: 4,
        color: Color.Transparent
      })
      .position({ x: 229, y: 588 })
      .onClick(() => {
        this.startPuzzle();
      })
    }
    .width(712)
    .height(776)
  }

  // å•å±å¸ƒå±€ï¼ˆæ‰€æœ‰å‚æ•°å†™æ­»ï¼‰
  @Builder
  buildSingleLayout() {
    Stack() {
      // èƒŒæ™¯å›¾ç‰‡
      Image($rawfile('images/ä¸»é¡µé¢èƒŒæ™¯å›¾.jpg'))
        .width('100%')
        .height('100%')
        .objectFit(ImageFit.Cover)

      // å£°éŸ³æŽ§åˆ¶æŒ‰é’®ï¼ˆå³ä¸Šè§’ï¼‰
      SoundButton({ buttonSize: 35, iconSize: 20 })
        .position({ x: 723, y: 11 })

      // å¼€å§‹æ‹¼å›¾æŒ‰é’®ï¼ˆå†™æ­»æ‰€æœ‰å‚æ•°ï¼‰
      Button() {
        Text('å¼€å§‹æ‹¼å›¾')
          .fontFamily('Muyao-Softbrush')
          .fontSize(48)
          .fontColor('#000000')
      }
      .width(254)
      .height(74)
      .backgroundColor('rgba(255, 255, 255, 0.91)')
      .borderRadius(25)
      .border({
        width: 4,
        color: Color.Transparent
      })
      .position({ x: 40, y: 138 })
      .onClick(() => {
        this.startPuzzle();
      })
    }
    .width(776)
    .height(350)
  }

  build() {
    Column() {
      if (this.screenState === ScreenState.TRIPLE) {
        this.buildTripleLayout()
      } else if (this.screenState === ScreenState.DOUBLE) {
        this.buildDoubleLayout()
      } else {
        this.buildSingleLayout()
      }
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }
}

