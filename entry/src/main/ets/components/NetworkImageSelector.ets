import { NetworkImageService, ImageData } from '../utils/NetworkImageService';
import { GameConstants } from '../constants/GameConstants';

/**
 * ç½‘ç»œå›¾ç‰‡é€‰æ‹©å¯¹è¯æ¡†
 */
@CustomDialog
export struct NetworkImageSelector {
  controller: CustomDialogController;
  onImageSelected?: (imageUrl: string) => void;

  @State searchKeyword: string = '';
  @State images: ImageData[] = [];
  @State isLoading: boolean = false;
  @State selectedImageUrl: string = '';

  async aboutToAppear() {
    // é»˜è®¤åŠ è½½éšæœºå›¾ç‰‡
    await this.loadRandomImages();
  }

  // åŠ è½½éšæœºå›¾ç‰‡
  private async loadRandomImages(): Promise<void> {
    this.isLoading = true;
    try {
      this.images = await NetworkImageService.getRandomImages();
    } catch (error) {
      console.error('åŠ è½½éšæœºå›¾ç‰‡å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  // æœç´¢å›¾ç‰‡
  private async searchImages(): Promise<void> {
    if (!this.searchKeyword.trim()) {
      await this.loadRandomImages();
      return;
    }

    this.isLoading = true;
    try {
      this.images = await NetworkImageService.searchImages(this.searchKeyword);
    } catch (error) {
      console.error('æœç´¢å›¾ç‰‡å¤±è´¥:', error);
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    Column({ space: 16 }) {
      // æ ‡é¢˜
      Text('ç½‘ç»œå›¾ç‰‡æœç´¢')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor(GameConstants.COLORS.TEXT)

      // æœç´¢æ¡†
      Row({ space: 8 }) {
        TextInput({ placeholder: 'è¾“å…¥å…³é”®å­—ï¼ˆå¦‚ï¼šè‡ªç„¶ã€åŠ¨ç‰©ï¼‰', text: this.searchKeyword })
          .layoutWeight(1)
          .onChange((value: string) => {
            this.searchKeyword = value;
          })
          .onSubmit(() => {
            this.searchImages();
          })

        Button('æœç´¢')
          .height(40)
          .onClick(() => {
            this.searchImages();
          })

        Button('éšæœº')
          .height(40)
          .onClick(() => {
            this.loadRandomImages();
          })
      }
      .width('100%')

      // å›¾ç‰‡ç½‘æ ¼
      if (this.isLoading) {
        Column() {
          LoadingProgress()
            .width(40)
            .height(40)
          Text('åŠ è½½ä¸­...')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 8 })
        }
        .width('100%')
        .height(300)
        .justifyContent(FlexAlign.Center)
      } else if (this.images.length === 0) {
        Column() {
          Text('ğŸ˜”')
            .fontSize(48)
          Text('æœªæ‰¾åˆ°å›¾ç‰‡')
            .fontSize(14)
            .fontColor('#999999')
            .margin({ top: 8 })
        }
        .width('100%')
        .height(300)
        .justifyContent(FlexAlign.Center)
      } else {
        Scroll() {
          Grid() {
            ForEach(this.images.slice(0, 12), (img: ImageData) => {
              GridItem() {
                Column() {
                  Image(img.previewURL)
                    .width('100%')
                    .height(100)
                    .objectFit(ImageFit.Cover)
                    .borderRadius(8)
                    .border({
                      width: this.selectedImageUrl === img.webformatURL ? 3 : 0,
                      color: GameConstants.COLORS.PRIMARY
                    })

                  Text(img.tags.split(',')[0])
                    .fontSize(12)
                    .fontColor('#666666')
                    .maxLines(1)
                    .textOverflow({ overflow: TextOverflow.Ellipsis })
                    .margin({ top: 4 })
                }
                .onClick(() => {
                  this.selectedImageUrl = img.webformatURL;
                })
              }
            })
          }
          .columnsTemplate('1fr 1fr 1fr')
          .rowsGap(12)
          .columnsGap(12)
          .width('100%')
        }
        .width('100%')
        .height(300)
        .scrollBar(BarState.Auto)
      }

      // æŒ‰é’®ç»„
      Row({ space: 12 }) {
        Button('å–æ¶ˆ')
          .layoutWeight(1)
          .height(44)
          .backgroundColor(Color.White)
          .fontColor(GameConstants.COLORS.TEXT)
          .border({ width: 1, color: '#E0E0E0' })
          .onClick(() => {
            this.controller.close();
          })

        Button('ç¡®å®š')
          .layoutWeight(1)
          .height(44)
          .backgroundColor(GameConstants.COLORS.PRIMARY)
          .enabled(this.selectedImageUrl !== '')
          .onClick(() => {
            if (this.selectedImageUrl && this.onImageSelected) {
              this.onImageSelected(this.selectedImageUrl);
            }
            this.controller.close();
          })
      }
      .width('100%')
    }
    .padding(24)
    .backgroundColor(Color.White)
    .borderRadius(16)
  }
}

