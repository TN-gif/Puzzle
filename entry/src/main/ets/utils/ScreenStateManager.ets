import { display, window } from '@kit.ArkUI';
import { BusinessError } from '@kit.BasicServicesKit';

/**
 * å±å¹•çŠ¶æ€æšä¸¾
 */
export enum ScreenState {
  TRIPLE = 'triple',   // ä¸‰å±
  DOUBLE = 'double',   // åŒå±
  SINGLE = 'single'    // å•å±
}

/**
 * æŠ˜å å±çŠ¶æ€ç®¡ç†å™¨
 * è´Ÿè´£æ£€æµ‹è®¾å¤‡æŠ˜å çŠ¶æ€å¹¶æä¾›å“åº”å¼å›è°ƒ
 * å®ç°åŸºäºå®˜æ–¹æœ€ä½³å®è·µå»ºè®®
 */
export class ScreenStateManager {
  private static instance: ScreenStateManager | null = null;
  private currentState: ScreenState = ScreenState.TRIPLE;
  private currentOrientation: window.Orientation = window.Orientation.LANDSCAPE;
  private listeners: ((state: ScreenState) => void)[] = [];
  private windowStage: window.WindowStage | null = null;
  private mainWindow: window.Window | null = null;
  private updateTimer: number = -1;
  private readonly DEBOUNCE_TIME: number = 200; // é˜²æŠ–æ—¶é—´ï¼ˆå®˜æ–¹å»ºè®®200msï¼‰
  private readonly ORIENTATION_WAIT_TIME: number = 100; // æ–¹å‘åˆ‡æ¢ç­‰å¾…æ—¶é—´ï¼ˆå®˜æ–¹å»ºè®®ï¼‰
  private isTransitioning: boolean = false; // æŠ˜å çŠ¶æ€è¿‡æ¸¡æ ‡å¿—ä½ï¼ˆå®˜æ–¹å»ºè®®ï¼‰

  private constructor() {}

  static getInstance(): ScreenStateManager {
    if (!ScreenStateManager.instance) {
      ScreenStateManager.instance = new ScreenStateManager();
    }
    return ScreenStateManager.instance;
  }

  /**
   * åˆå§‹åŒ–å±å¹•çŠ¶æ€ç®¡ç†å™¨
   */
  async init(windowStage: window.WindowStage): Promise<void> {
    this.windowStage = windowStage;
    
    try {
      this.mainWindow = await windowStage.getMainWindow();
      
      // æ£€æŸ¥æ˜¯å¦ä¸ºæŠ˜å å±è®¾å¤‡ï¼ˆå¢å¼ºæ£€æµ‹ - å®˜æ–¹å»ºè®®ï¼‰
      const isFoldable: boolean = display.isFoldable();
      const allDisplays: Array<display.Display> = await display.getAllDisplays();
      const isFoldableEnhanced: boolean = isFoldable || allDisplays.length > 1;
      
      console.info(`[ScreenStateManager] è®¾å¤‡æŠ˜å æ”¯æŒ: ${isFoldable}, å¢å¼ºæ£€æµ‹: ${isFoldableEnhanced}`);
      console.info(`[ScreenStateManager] æ˜¾ç¤ºå±æ•°é‡: ${allDisplays.length}`);
      
      await this.updateScreenState();
      this.registerFoldStatusListener();
    } catch (err) {
      console.error('[ScreenStateManager] âŒ åˆå§‹åŒ–å¤±è´¥:', err);
    }
  }

  /**
   * æ›´æ–°å±å¹•çŠ¶æ€ï¼ˆå¸¦é˜²æŠ– - å®˜æ–¹å»ºè®®ï¼‰
   */
  private handleStateChange(): void {
    clearTimeout(this.updateTimer);
    this.updateTimer = setTimeout(() => {
      this.updateScreenState();
    }, this.DEBOUNCE_TIME);
  }

  /**
   * æ›´æ–°å±å¹•çŠ¶æ€ï¼ˆæ ¸å¿ƒé€»è¾‘ - ä¿®æ­£ç‰ˆï¼‰
   * æ‰§è¡Œé¡ºåºï¼š
   * 1. è·å–æŠ˜å çŠ¶æ€
   * 2. è·å–çª—å£å°ºå¯¸
   * 3. åˆ¤æ–­ç›®æ ‡çŠ¶æ€å’Œæ–¹å‘
   * 4. æ£€æŸ¥çŠ¶æ€æ˜¯å¦å˜åŒ–ï¼ˆå¦‚æœæ²¡å˜åŒ–ç›´æ¥è¿”å›ï¼‰
   * 5. è®¾ç½®å±å¹•æ–¹å‘
   * 6. ç­‰å¾…æ–¹å‘åˆ‡æ¢å®Œæˆ
   * 7. æ›´æ–°çŠ¶æ€
   * 8. é€šçŸ¥ç›‘å¬å™¨
   */
  private async updateScreenState(): Promise<void> {
    try {
      if (!this.mainWindow) {
        return;
      }

      // æ­¥éª¤1ï¼šè·å–æŠ˜å çŠ¶æ€ï¼ˆä¸»åˆ¤æ–­ä¾æ®ï¼‰
      const foldStatus: display.FoldStatus = display.getFoldStatus();
      
      // æ­¥éª¤2ï¼šè·å–çª—å£å°ºå¯¸å’Œåƒç´ å¯†åº¦
      const windowProperties: window.WindowProperties = this.mainWindow.getWindowProperties();
      const rect: window.Rect = windowProperties.windowRect;
      let widthPx: number = rect.width;   // ç‰©ç†åƒç´ 
      let heightPx: number = rect.height; // ç‰©ç†åƒç´ 
      
      // è·å–åƒç´ å¯†åº¦ä»¥è½¬æ¢ä¸ºvp
      const displayClass = display.getDefaultDisplaySync();
      const densityPixels: number = displayClass.densityPixels;
      
      // è§„èŒƒåŒ–å°ºå¯¸ï¼šç¡®ä¿æˆ‘ä»¬æ€»æ˜¯ç”¨è¾ƒå¤§çš„å€¼ä½œä¸º"å±•å¼€å®½åº¦"æ¥åˆ¤æ–­
      // è¿™æ ·å¯ä»¥é¿å…å½“å‰æ–¹å‘å½±å“åˆ¤æ–­
      const dimension1Vp: number = widthPx / densityPixels;
      const dimension2Vp: number = heightPx / densityPixels;
      const maxDimensionVp: number = Math.max(dimension1Vp, dimension2Vp);
      const minDimensionVp: number = Math.min(dimension1Vp, dimension2Vp);
      
      console.info(`[ScreenStateManager] ğŸ“Š æŠ˜å çŠ¶æ€: ${foldStatus}`);
      console.info(`[ScreenStateManager] ğŸ“ çª—å£å°ºå¯¸(ç‰©ç†åƒç´ ): ${widthPx}px Ã— ${heightPx}px`);
      console.info(`[ScreenStateManager] ğŸ“ åƒç´ å¯†åº¦: ${densityPixels}`);
      console.info(`[ScreenStateManager] ğŸ“ å°ºå¯¸èŒƒå›´(vp): ${minDimensionVp.toFixed(0)}vp ~ ${maxDimensionVp.toFixed(0)}vp`);

      // æ­¥éª¤3ï¼šæ ¹æ®æŠ˜å çŠ¶æ€å’Œçª—å£å°ºå¯¸åˆ¤æ–­ç›®æ ‡æ¨¡å¼å’Œæ–¹å‘
      // æ³¨æ„ï¼šåœ¨åä¸ºæŠ˜å å±ä¸Šï¼ŒåŒå±å’Œä¸‰å±éƒ½å¯èƒ½æ˜¯EXPANDEDçŠ¶æ€ï¼Œéœ€è¦ç»“åˆå°ºå¯¸åˆ¤æ–­
      let newState: ScreenState;
      let targetOrientation: window.Orientation;
      
      if (foldStatus === display.FoldStatus.FOLD_STATUS_FOLDED) {
        // å®Œå…¨æŠ˜å  â†’ å•å±æ¨ªå±
        newState = ScreenState.SINGLE;
        targetOrientation = window.Orientation.LANDSCAPE;
        console.info('[ScreenStateManager] ğŸ“± å®Œå…¨æŠ˜å (FOLDED) â†’ å•å±æ¨ªå±');
        
      } else if (foldStatus === display.FoldStatus.FOLD_STATUS_HALF_FOLDED) {
        // åŠæŠ˜å  â†’ åŒå±ç«–å±
        newState = ScreenState.DOUBLE;
        targetOrientation = window.Orientation.PORTRAIT;
        console.info('[ScreenStateManager] ğŸ“± åŠæŠ˜å (HALF_FOLDED) â†’ åŒå±ç«–å±');
        
      } else {
        // FOLD_STATUS_EXPANDED å±•å¼€çŠ¶æ€ â†’ æ ¹æ®çª—å£å°ºå¯¸åˆ¤æ–­åŒå±æˆ–ä¸‰å±
        // è®¾è®¡å°ºå¯¸ï¼šåŒå± 712vp Ã— 776vpï¼Œä¸‰å± 1107vp Ã— 776vp
        // é˜ˆå€¼è®¾ä¸º 900vp
        if (maxDimensionVp >= 900) {
          // æœ€å¤§ç»´åº¦ â‰¥ 900vp â†’ ä¸‰å±æ¨ªå±
          newState = ScreenState.TRIPLE;
          targetOrientation = window.Orientation.LANDSCAPE;
          console.info(`[ScreenStateManager] ğŸ“º å±•å¼€æ€(${maxDimensionVp.toFixed(0)}vp) â†’ ä¸‰å±æ¨ªå±`);
        } else {
          // æœ€å¤§ç»´åº¦ < 900vp â†’ åŒå±ç«–å±
          newState = ScreenState.DOUBLE;
          targetOrientation = window.Orientation.PORTRAIT;
          console.info(`[ScreenStateManager] ğŸ“± å±•å¼€æ€(${maxDimensionVp.toFixed(0)}vp) â†’ åŒå±ç«–å±`);
        }
      }

      // æ­¥éª¤4ï¼šæ£€æŸ¥çŠ¶æ€å’Œæ–¹å‘æ˜¯å¦å˜åŒ–
      const stateChanged: boolean = this.currentState !== newState;
      const orientationChanged: boolean = this.currentOrientation !== targetOrientation;
      
      console.info(`[ScreenStateManager] å½“å‰çŠ¶æ€: ${this.currentState}, ç›®æ ‡çŠ¶æ€: ${newState}, çŠ¶æ€å˜åŒ–: ${stateChanged}`);
      console.info(`[ScreenStateManager] å½“å‰æ–¹å‘: ${this.currentOrientation === window.Orientation.LANDSCAPE ? 'æ¨ªå±' : this.currentOrientation === window.Orientation.PORTRAIT ? 'ç«–å±' : 'æœªçŸ¥'}, ç›®æ ‡æ–¹å‘: ${targetOrientation === window.Orientation.LANDSCAPE ? 'æ¨ªå±' : 'ç«–å±'}, æ–¹å‘å˜åŒ–: ${orientationChanged}`);
      
      // å¦‚æœçŠ¶æ€å’Œæ–¹å‘éƒ½æœªå˜åŒ–ï¼Œç›´æ¥è¿”å›
      if (!stateChanged && !orientationChanged) {
        console.info('[ScreenStateManager] â­ï¸  çŠ¶æ€å’Œæ–¹å‘éƒ½æœªå˜åŒ–ï¼Œè·³è¿‡æ›´æ–°');
        return;
      }

      // æ­¥éª¤5ï¼šè®¾ç½®å±å¹•æ–¹å‘ï¼ˆå®˜æ–¹å»ºè®®ï¼šmodule.json5å·²è®¾ç½®portraitåŸºå‡†ï¼Œæ­¤å¤„ä»…å¤„ç†ç‰¹æ®Šæƒ…å†µï¼‰
      if (orientationChanged) {
        console.info(`[ScreenStateManager] ğŸ”„ æ–¹å‘éœ€è¦æ”¹å˜ï¼Œè®¾ç½®ä¸º: ${targetOrientation === window.Orientation.LANDSCAPE ? 'æ¨ªå±' : 'ç«–å±'}`);
        await this.mainWindow.setPreferredOrientation(targetOrientation);
        await new Promise<void>(resolve => setTimeout(resolve, this.ORIENTATION_WAIT_TIME));
        this.currentOrientation = targetOrientation;
        console.info('[ScreenStateManager] âœ… æ–¹å‘è®¾ç½®å®Œæˆ');
      } else {
        console.info('[ScreenStateManager] â­ï¸  æ–¹å‘æ— éœ€æ”¹å˜ï¼Œè·³è¿‡æ–¹å‘è®¾ç½®');
      }
      
      // æ­¥éª¤6ï¼šæ›´æ–°çŠ¶æ€
      if (stateChanged) {
        this.currentState = newState;
        console.info(`[ScreenStateManager] ğŸ¯ çŠ¶æ€å·²æ›´æ–°: ${this.currentState}`);
      }
      
      // æ­¥éª¤7ï¼šé€šçŸ¥ç›‘å¬å™¨
      this.notifyListeners();
      console.info('[ScreenStateManager] ğŸ“¢ å·²é€šçŸ¥ç›‘å¬å™¨');
      
    } catch (err) {
      console.error('[ScreenStateManager] âŒ æ›´æ–°å¤±è´¥:', err);
    }
  }

  /**
   * æ³¨å†ŒæŠ˜å çŠ¶æ€å˜åŒ–ç›‘å¬å™¨ï¼ˆé‡‡ç”¨å®˜æ–¹å»ºè®®çš„åŒäº‹ä»¶ååŒæœºåˆ¶ï¼‰
   */
  private registerFoldStatusListener(): void {
    try {
      // ä¸»ç›‘å¬ï¼šæŠ˜å çŠ¶æ€å˜åŒ–ï¼ˆå®˜æ–¹æ¨èä¼˜å…ˆçº§1ï¼Œä¸»å¯¼ä¿¡å·ï¼‰
      display.on('foldStatusChange', async (foldStatus: display.FoldStatus) => {
        console.info(`[ScreenStateManager] ğŸ”” [ä¸»å¯¼] æŠ˜å çŠ¶æ€å˜åŒ–äº‹ä»¶: ${foldStatus}`);
        // è®¾ç½®è¿‡æ¸¡æ ‡å¿—ä½ï¼Œé¿å…æŠ˜å è¿‡ç¨‹ä¸­çš„ä¸­é—´çŠ¶æ€å¹²æ‰°
        this.isTransitioning = true;
        console.info('[ScreenStateManager] ğŸš© è¿‡æ¸¡æ ‡å¿—ä½å·²è®¾ç½®ï¼Œçª—å£å°ºå¯¸å˜åŒ–å°†è¢«å¿½ç•¥');
        
        // å¤„ç†çŠ¶æ€å˜åŒ–
        await this.handleStateChangeAsync(foldStatus);
        
        // æ¸…é™¤è¿‡æ¸¡æ ‡å¿—ä½
        this.isTransitioning = false;
        console.info('[ScreenStateManager] âœ… è¿‡æ¸¡æ ‡å¿—ä½å·²æ¸…é™¤');
      });

      // è¾…åŠ©ç›‘å¬ï¼šçª—å£å¤§å°å˜åŒ–ï¼ˆå®˜æ–¹æ¨èä¼˜å…ˆçº§2ï¼Œä»…ä½œè¡¥å……ï¼‰
      if (this.mainWindow) {
        this.mainWindow.on('windowSizeChange', (size: window.Size) => {
          console.info(`[ScreenStateManager] ğŸ”” [è¾…åŠ©] çª—å£å¤§å°å˜åŒ–äº‹ä»¶: ${size.width}Ã—${size.height}`);
          
          // å®˜æ–¹å»ºè®®ï¼šæŠ˜å è¿‡æ¸¡æœŸé—´å¿½ç•¥çª—å£å°ºå¯¸å˜åŒ–ï¼Œé¿å…ä¸­é—´çŠ¶æ€å¹²æ‰°
          if (this.isTransitioning) {
            console.info('[ScreenStateManager] â­ï¸  è¿‡æ¸¡æœŸé—´ï¼Œè·³è¿‡çª—å£å°ºå¯¸å˜åŒ–å¤„ç†');
            return;
          }
          
          // éè¿‡æ¸¡æœŸé—´æ‰å¤„ç†çª—å£å°ºå¯¸å˜åŒ–
          this.handleStateChange();
        });
      }
      
      console.info('[ScreenStateManager] âœ… ç›‘å¬å™¨æ³¨å†ŒæˆåŠŸï¼ˆåŒäº‹ä»¶ååŒæœºåˆ¶ï¼‰');
    } catch (err) {
      console.error('[ScreenStateManager] âŒ æ³¨å†Œç›‘å¬å™¨å¤±è´¥:', err);
    }
  }

  /**
   * å¤„ç†çŠ¶æ€å˜åŒ–ï¼ˆå¼‚æ­¥ç‰ˆæœ¬ï¼Œç”¨äº foldStatusChange ä¸»å¯¼äº‹ä»¶ï¼‰
   */
  private async handleStateChangeAsync(foldStatus: display.FoldStatus): Promise<void> {
    // æ¸…é™¤ä¹‹å‰çš„é˜²æŠ–å®šæ—¶å™¨
    clearTimeout(this.updateTimer);
    // ç›´æ¥æ›´æ–°çŠ¶æ€ï¼Œä¸éœ€è¦é˜²æŠ–
    await this.updateScreenState();
  }

  /**
   * æ·»åŠ çŠ¶æ€å˜åŒ–ç›‘å¬å™¨
   */
  addListener(listener: (state: ScreenState) => void): void {
    this.listeners.push(listener);
  }

  /**
   * ç§»é™¤çŠ¶æ€å˜åŒ–ç›‘å¬å™¨
   */
  removeListener(listener: (state: ScreenState) => void): void {
    const index = this.listeners.indexOf(listener);
    if (index > -1) {
      this.listeners.splice(index, 1);
    }
  }

  /**
   * é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨
   */
  private notifyListeners(): void {
    this.listeners.forEach(listener => {
      listener(this.currentState);
    });
  }

  /**
   * è·å–å½“å‰å±å¹•çŠ¶æ€
   */
  getCurrentState(): ScreenState {
    return this.currentState;
  }

  /**
   * æ¸…ç†èµ„æº
   */
  destroy(): void {
    try {
      // æ¸…é™¤é˜²æŠ–å®šæ—¶å™¨
      if (this.updateTimer !== -1) {
        clearTimeout(this.updateTimer);
      }
      
      // å–æ¶ˆæŠ˜å çŠ¶æ€ç›‘å¬
      display.off('foldStatusChange');
      
      // å–æ¶ˆçª—å£å¤§å°ç›‘å¬
      if (this.mainWindow) {
        this.mainWindow.off('windowSizeChange');
      }
      
      this.listeners = [];
      console.info('[ScreenStateManager] âœ… èµ„æºæ¸…ç†å®Œæˆ');
    } catch (err) {
      console.error('[ScreenStateManager] âŒ æ¸…ç†èµ„æºå¤±è´¥:', err);
    }
  }
}

